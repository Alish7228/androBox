#!/data/data/com.termux/files/usr/bin/bash

clear

oldloader(){

export CLASSPATH=/data/data/com.termux/files/usr/glibc/loader.apk
unset LD_LIBRARY_PATH LD_PRELOAD
exec /system/bin/app_process / com.termux.x11.Loader :1 >/dev/null 2>&1 &

}

apply_last_patch(){

echo -e "\nChecking for available patches..."
lastavailablepatch="$(curl -sL https://github.com/Pipetto-crypto/androBox/raw/androBoxNew/patches/patch.tar.xz | sha1sum | awk '{print $1}')"
lastinstalledpatch="$(cat /sdcard/androBox/.patch1sum)"
isonline="$(ping -w1 -q -c1 google.com &>/dev/null && echo $?)"

if [ "$lastavailablepatch" == "$lastinstalledpatch" ]
then
     echo -e "\nLast patch is already installed"
elif [ "$isonline" == "0" ]
then
     echo -e "\nInstalling last patch"
     apply_patch >/dev/null 2>&1
     echo -e "\nLast patch installed"
else
     echo -e "\nI am not capable of find any new patch online, enable your Internet connection next time."
fi

}

update_scripts(){

echo -e "\nChecking for available scripts update..\n"
touch /sdcard/androBox/.lastupdated
lastavailablecommit="$(git ls-remote --heads https://github.com/Pipetto-crypto/androBox.git | grep refs/heads/androBoxNew | awk '{print $1}')"
lastinstalledcommit="$(cat /sdcard/androBox/.lastupdated)"

if [ ! -z "$lastavailablecommit" ]
then 
     if [ "$lastavailablecommit" == "$lastinstalledcommit" ]
     then
          echo -e "\nNo new updates found"
     else
          echo -e "\nInstalling new updates"
          source update-scripts >/dev/null 2>&1
          echo -e "\nNew updates installed"
     fi
else
     echo -e "\nI am not capable of finding any new update, enable your Internet connection next time"
fi


}

update_scripts
apply_last_patch


if [ "$(pidof app_process)" == "" ]
then
     if [ "$1" == "-ol" ]
     then
          oldloader
          sleep 7
     else
          termux-x11 :1 >/dev/null 2>&1 &
          sleep 7
     fi
fi


echo -e "\nTrying to apply correct resolution, the desktop will restart multiple times until correct resolution is applied"

sleep 3

screenres=$(DISPLAY=:1 xrandr | grep current | awk '{print $8$9$10}' | tr -d ,)
[[ -z $(grep -w "checkres=disabled" $HOME/.androBox) ]] && [[ -z $(ps -aux | grep "[w]atch" | awk '{print $2}') ]] && $PREFIX/glibc/opt/WinScripts/checkres.sh &

echo -e "\nLaunching"

sleep 3

am start -n com.termux.x11/com.termux.x11.MainActivity >/dev/null 2>&1
wine explorer /desktop=shell,$screenres $PREFIX/glibc/opt/WinScripts/startup.bat

if [ "$(grep -w 'checkres=disabled' $HOME/.androBox)" == "" ]
then
     kill -9 $(ps -aux | grep "[c]heckres" | awk '{print $2}') 
     kill -9 $(ps -aux | grep "[w]atch" | awk '{print $2}')
fi

